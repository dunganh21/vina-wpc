<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VINA WPC - Quản lý nội dung</title>
</head>
<body>
  <!-- Use Decap CMS (formerly Netlify CMS) -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <script>
    console.log('Loading Decap CMS...');

    // Wait for CMS to load
    window.addEventListener('load', function() {
      if (window.DecapCms) {
        console.log('Decap CMS loaded successfully');
        
        // Custom preview template for blog posts
        const BlogPreview = ({ entry, widgetFor, getAsset }) => {
          const title = entry.getIn(['data', 'title']);
          const date = entry.getIn(['data', 'date']);
          const category = entry.getIn(['data', 'category']);
          const image = getAsset(entry.getIn(['data', 'image']));
          const body = widgetFor('body');
          
          return `
            <div style="max-width: 800px; margin: 0 auto; font-family: Inter, sans-serif; padding: 20px;">
              <div style="margin-bottom: 20px;">
                <h1 style="color: #3C5F3E; font-size: 2.5rem; margin-bottom: 10px;">${title || 'Untitled'}</h1>
                <div style="color: #6B5B3A; margin-bottom: 10px;">
                  <span>Danh mục: ${category || 'Chưa phân loại'}</span>
                  ${date ? ` • <span>${new Date(date).toLocaleDateString('vi-VN')}</span>` : ''}
                </div>
                ${image ? `<img src="${image}" alt="${title}" style="width: 100%; height: 300px; object-fit: cover; margin-bottom: 20px;">` : ''}
              </div>
              <div style="line-height: 1.6; color: #424c43;">
                ${body || '<p>Chưa có nội dung...</p>'}
              </div>
            </div>
          `;
        };

        // Register preview template
        window.DecapCms.registerPreviewTemplate('blog', BlogPreview);

        // Fix cursor position issues with Vietnamese input
        window.DecapCms.registerEventListener({
          name: 'preSave',
          handler: function() {
            console.log('Pre-save event triggered');
          }
        });

        // Configure CMS
        window.DecapCms.init({
          config: {
            load_config_file: true,
            slug: {
              encoding: 'unicode'
            }
          }
        });

        // Fix cursor jumping in markdown editor
        setTimeout(() => {
          const style = document.createElement('style');
          style.textContent = `
            /* Fix markdown editor cursor issues */
            .cms-editor-visual .public-DraftEditor-content,
            .cms-editor-raw textarea {
              ime-mode: active !important;
              -webkit-ime-mode: active !important;
            }
            
            /* Ensure proper Vietnamese text rendering */
            .cms-editor-visual .public-DraftEditor-content {
              font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
              line-height: 1.5;
              letter-spacing: normal;
            }
            
            /* Fix composition events for Vietnamese input */
            .cms-editor-visual .DraftEditor-root,
            .cms-editor-raw textarea {
              composition-event: auto;
            }
          `;
          document.head.appendChild(style);
        }, 1000);

      } else {
        console.error('Decap CMS failed to load');
        setTimeout(arguments.callee, 1000);
      }
    });
  </script>
</body>
</html>